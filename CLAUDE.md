# ČOI Blacklist Extension

## What This Is

Browser extension that warns users when they visit websites on the Czech Trade Inspection Authority (ČOI) blacklist of risky/fraudulent websites.

**Stack:** Manifest V3, vanilla JavaScript, no build step, no dependencies.

## Project Structure

```
coi-blacklist-extension/
├── manifest.json          # Extension config + CSP
├── background.js          # Service worker (data updates, message handling)
├── content.js             # Injected warning banner
├── content.css            # Banner styles (.pnn-* prefix)
├── popup/                 # Extension popup UI
│   ├── popup.html
│   ├── popup.css
│   └── popup.js
├── options/               # Settings page
│   ├── options.html
│   ├── options.css
│   └── options.js
├── scripts/
│   └── update-blacklist.js  # Node.js: scrapes ČOI website
├── .github/workflows/
│   └── update-data.yml    # Daily CI to fetch fresh data
├── data/blacklist.json    # Generated by CI
└── icons/                 # 16, 32, 48, 128px PNG
```

## Key Technical Details

### Domain Normalization (Critical!)

Always normalize with `.trim()` before matching:

```javascript
function normalizeDomain(url) {
  try {
    let hostname = new URL(url).hostname.toLowerCase().trim();
    return hostname.replace(/^www\./, '');
  } catch {
    return null;
  }
}
```

### Data Flow

```
ČOI Website (HTML) → GitHub Actions → blacklist.json → Extension storage → Content script
```

### HTML Scraping (scripts/update-blacklist.js)

The script fetches the ČOI website HTML and parses `<article class="information-row">` elements:
- Extracts domain from `<span>` inside `.list_titles`
- Extracts date from `(DD. MM. YYYY)` pattern
- Extracts reason from `<p>` tags

### Storage Schema

```javascript
chrome.storage.local.set({
  blacklist: {
    metadata: { lastUpdated, source: 'ČOI', count },
    domains: ['example.com', ...],  // normalized domains
    details: { 'example.com': { reason, dateAdded } }
  },
  settings: { enabled, bannerPosition, whitelist: [] },
  dismissals: { 'example.com': timestamp }  // 7-day expiry
});
```

### Message Passing

Background service worker handles these messages (with origin validation):

```javascript
{ action: 'forceUpdate' }     // Trigger manual update
{ action: 'getStatus' }       // Get blacklist + settings
{ action: 'checkDomain', domain }  // Check if domain is blacklisted
```

### CSS Prefixing

All content script CSS classes use `pnn-` prefix to avoid conflicts:

```css
.pnn-banner { }
.pnn-container { }
.pnn-details { }
```

## Design

### Color Scheme

- **Warning banner:** Red (`#dc2626`) - indicates danger on blacklisted sites
- **Popup/Options UI:** Amber/yellow (`#f59e0b`, `#d97706`) - neutral, non-alarming
- **Success states:** Green (`#10b981`)

### UI Text

All user-facing text is in Czech. Button states:
- Loading: "Aktualizuji..."
- Success: "Hotovo ✓"
- Offline: "Nelze připojit"
- Error: "Chyba"

## Security

### Implemented Protections

1. **CSP** - Explicit Content Security Policy in manifest.json
2. **Message origin validation** - Only accepts messages from extension pages
3. **Domain validation** - Validates each domain entry (string, non-empty, <256 chars)
4. **XSS prevention** - `escapeHtml()` for all user-controlled data in DOM

### Security Considerations

- Remote JSON is fetched over HTTPS only
- No sensitive data stored (just domains and timestamps)
- Errors fail silently in content script to not disrupt browsing

## Commands

```bash
# Load extension in Chrome
# → chrome://extensions → Developer mode → Load unpacked

# Test data update locally
node scripts/update-blacklist.js

# No build step, no npm install needed
```

## Conventions

- **Language:** UI text in Czech, all comments in English
- **Style:** const/let, async/await, 2-space indent, single quotes
- **Privacy:** No tracking, no analytics, works offline
- **Logging:** No console.log in production (removed for cleanliness)

## Testing

```javascript
// DevTools Console → inject test data
chrome.storage.local.set({
  blacklist: {
    metadata: { lastUpdated: new Date().toISOString(), count: 1 },
    domains: ['example.com'],
    details: { 'example.com': { reason: 'Test', dateAdded: '2024-01-01' } }
  }
});
// Then visit example.com
```

## Data Sources

- **Primary:** https://coi.gov.cz/pro-spotrebitele/rizikove-e-shopy/ (HTML scraping)
- **Remote JSON:** https://raw.githubusercontent.com/simonmarek/coi-blacklist-extension/main/data/blacklist.json
